h2
  - i = 0
  - @album.artists.each do |a|
    - if i > 0
      ' /
    a href=path_to(:artist).with(a.id) = a.title
    - i += 1
  |  - 
  = "#{@album.title} [#{@album.year}]"

audio#main-player preload="none" controls="controls" style="width: 500px"

h2 Tracks
ul.playlist
  - @tracks.each do |t|
    li
      a.ajax-link.track-playback-link data-track-url=(path_to(:download).with(@album.id, t.filename)) = t.filename
      |  (
      a href=(path_to(:download).with(@album.id, t.filename)) Download
      '  |
      a.ajax-link.track-add-note-link data-id=t.id Add note
      | )
      == slim :tags_form, locals: {parent_object: t}
      == slim :notes_table, locals: {notes: @notes[t.id]}
      div.track-note-form id="note-form-#{t.id}"
        == slim :note_form, locals: {note_parent: t}

h2 Notes
== slim :notes_table, locals: {notes: @album.notes}
== slim :note_form, locals: {note_parent: @album}

javascript:
  var playlist = [];
  var play_index = 0;

  $(document).on('click', '.track-add-note-link', function(){
    var id = $(this).data('id');
    $("#note-form-" + id).show();
  });

  $(document).on('click', '.track-playback-link', function(){
    var track_url = $(this).data('track-url');
    playlist = [];
    $('.track-playback-link').each(function(){
      var url = $(this).data('track-url');
      playlist.push(url);
      console.log(url);
      if (url == track_url) {
        play_index = playlist.length - 1;
      }
    });

    play();
  });

  function play(){
    $('#main-player').attr('src', playlist[play_index]);
    $('#main-player')[0].play();
    $('.track-now-playing').removeClass('track-now-playing');
    $('.track-playback-link').each(function(){
      if ($(this).data('track-url') == playlist[play_index]) {
        $(this).addClass('track-now-playing')
      }
    });
  }

  $('#main-player').on('ended', function(){
    play_index = play_index + 1;
    if (play_index < playlist.length) {
      $('#main-player')[0].currentTime = 0;
      play();
    }
  });
